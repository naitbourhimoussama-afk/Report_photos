<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1">
    <title>Photos Testes</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <!-- ZIP + SaveAs -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <!-- html2canvas pour capture d'écran -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    :root{
      --primary-dark:#04243c;--primary:#19484e;--primary-light:#2a6e7a;--accent:#5fa586;
      --accent-light:#8fc9b3;--light:#f8f9fa;--dark:#333;--gray:#7f8c8d;--light-gray:#ecf0f1;
      --error:#e74c3c;--warning:#f39c12;--success:#27ae60;
    }
    body{font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;background:linear-gradient(135deg,var(--primary-dark),var(--primary-light));min-height:100vh;padding:20px;color:var(--dark)}
    .container{max-width:1400px;margin:0 auto;background:#fff;border-radius:12px;box-shadow:0 15px 50px rgba(0,0,0,.15);overflow:hidden;border:1px solid rgba(0,0,0,.05)}
    .header{background:linear-gradient(135deg,var(--primary),var(--primary-light));color:#fff;padding:30px;text-align:center}
    .logo-container{margin-bottom:20px;display:flex;justify-content:center;gap:15px}
    .logo{height:60px;filter:drop-shadow(0 2px 4px rgba(0,0,0,.2))}
    .header h1{font-size:2.6rem;font-weight:600;text-shadow:0 2px 4px rgba(0,0,0,.2)}
    .content{padding:40px}

    .section-title{font-size:1.4rem;margin-bottom:25px;color:var(--primary);display:flex;align-items:center;gap:10px;padding-bottom:10px;border-bottom:2px solid var(--light-gray)}
    .section-title i{background:var(--primary);color:#fff;width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center}

    .project-info-section{background:linear-gradient(to bottom,var(--primary),var(--primary-dark));border-radius:12px;padding:30px;margin-bottom:30px;border:1px solid rgba(255,255,255,.1);color:#fff}
    .project-info-title{font-size:1.4rem;margin-bottom:25px;text-align:center;display:flex;align-items:center;justify-content:center;gap:10px}
    .project-info-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:20px}
    .info-field{display:flex;flex-direction:column}
    .info-field label{font-weight:600;margin-bottom:8px;color:var(--accent-light);font-size:.95rem}
    .info-field input{padding:12px 14px;border:1px solid rgba(255,255,255,.2);border-radius:8px;background:rgba(255,255,255,.1);color:#fff}
    .info-field input::placeholder{color:rgba(255,255,255,.6)}
    .info-field input:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px rgba(95,165,134,.25)}

    .upload-section{background:#fff;border-radius:12px;padding:35px;margin-bottom:30px;border:2px dashed var(--primary);text-align:center;box-shadow:0 5px 20px rgba(0,0,0,.05)}
    .upload-button{background:linear-gradient(135deg,var(--primary),var(--primary-dark));color:#fff;border:none;padding:14px 26px;border-radius:28px;font-size:1rem;cursor:pointer;margin:8px;display:inline-flex;align-items:center;gap:10px;font-weight:600;transition:all 0.3s}
    .upload-button:hover{transform:translateY(-2px);box-shadow:0 5px 15px rgba(0,0,0,0.2)}
    .upload-button:disabled{opacity:0.6;cursor:not-allowed;transform:none;}

    .tabs{display:flex;margin-bottom:30px;border-bottom:2px solid var(--light-gray)}
    .tab{padding:14px 26px;background:none;border:none;cursor:pointer;color:var(--gray);border-bottom:3px solid transparent;font-weight:600}
    .tab.active{color:var(--primary);border-bottom-color:var(--accent)}
    .tab-content{display:none}
    .tab-content.active{display:block}

    .categories-section{background:var(--light);border-radius:12px;padding:30px;margin-bottom:30px;box-shadow:0 5px 20px rgba(0,0,0,.05)}
    .categories-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:25px}
    .category-card{background:#fff;border-radius:10px;padding:20px;border:1px solid var(--light-gray);cursor:pointer;transition:all 0.3s}
    .category-card.selected{box-shadow:0 0 0 3px rgba(95,165,134,.2)}
    .category-card:hover{transform:translateY(-2px);box-shadow:0 5px 15px rgba(0,0,0,0.1)}

    .category-card .control-btn{background:none;color:#0f172a;border:none;width:32px;height:32px;border-radius:50%;cursor:pointer;transition:all .2s}
    .category-card .control-btn:hover{background:rgba(15,23,42,.06)}

    .category-card.add-card {
      border: 2px dashed var(--light-gray);
      background: #fbfbfb;
      text-align: center;
      color: #0f172a;
    }
    .category-card.add-card:hover { border-color: var(--accent); }

    .photos-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(360px,1fr));gap:30px}
    .photo-item{background:#fff;border-radius:12px;overflow:hidden;box-shadow:0 8px 20px rgba(0,0,0,.08);transition:all 0.3s}
    .photo-item:hover{transform:translateY(-2px);box-shadow:0 12px 30px rgba(0,0,0,.15)}
    .photo-container{position:relative;height:270px;overflow:hidden}
    .photo-img{width:100%;height:100%;object-fit:cover}
    .category-badge{position:absolute;top:15px;left:15px;background:rgba(52,152,219,.9);color:#fff;padding:6px 15px;border-radius:30px;font-size:.85rem;font-weight:600}
    .photo-controls{position:absolute;top:15px;right:15px;display:flex;gap:8px;background:rgba(0,0,0,.6);padding:6px;border-radius:30px}
    .control-btn{background:none;color:#fff;border:none;width:36px;height:36px;border-radius:50%;cursor:pointer;transition:all 0.3s}
    .control-btn:hover{background:rgba(255,255,255,0.2)}
    .photo-info{padding:18px}
    .photo-info input, .photo-info select{padding:8px;border:1px solid var(--light-gray);border-radius:6px;margin-bottom:8px;width:100%}
    .photo-details{display:flex;gap:10px}
    .photo-details input{margin-bottom:0}
    @media (max-width:768px){.photos-grid{grid-template-columns:1fr}.photo-details{flex-direction:column}}

    .export-section{text-align:center;margin-top:40px;padding:40px;background:linear-gradient(to bottom,var(--light),#fff);border-radius:15px;border:1px solid var(--light-gray)}
    .export-button{background:linear-gradient(135deg,var(--primary),var(--primary-dark));color:#fff;border:none;padding:16px 40px;border-radius:30px;font-size:1.1rem;font-weight:600;cursor:pointer;transition:all 0.3s}
    .export-button:hover{transform:translateY(-2px);box-shadow:0 5px 15px rgba(0,0,0,0.2)}
    .photo-count{font-size:1.1rem;color:var(--gray);margin-bottom:16px}

    .loading{display:none;text-align:center;padding:30px;color:var(--primary)}
    .spinner{width:48px;height:48px;border:4px solid var(--light-gray);border-top:4px solid var(--primary);border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 14px}
    @keyframes spin{to{transform:rotate(360deg)}}
    .progress-bar{height:6px;background:var(--light-gray);border-radius:3px;max-width:300px;margin:10px auto 0;overflow:hidden}
    .progress{height:100%;background:var(--accent);width:0;transition:width .3s}

    .toast{position:fixed;top:30px;right:30px;background:var(--primary);color:#fff;padding:14px 18px;border-radius:8px;z-index:1000;transform:translateX(120%);transition:transform .4s}
    .toast.show{transform:translateX(0)}
    .toast.error{background:var(--error)} .toast.warning{background:var(--warning)} .toast.success{background:var(--success)}

    .pdf-options{margin-top:20px;padding:20px;background:#f8f9fa;border-radius:10px;border:1px solid #e9ecef}
    .pdf-options h4{margin-bottom:15px;color:var(--primary)}
    .option-row{display:flex;align-items:center;gap:10px;margin-bottom:10px}
    .option-row label{font-size:14px;color:#495057;cursor:pointer}

    .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;z-index:3000}
    .modal{background:#fff;border-radius:12px;max-width:520px;width:95%;padding:20px;box-shadow:0 20px 60px rgba(0,0,0,.25)}
    .modal header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
    .modal header h3{margin:0}
    .modal .actions{display:flex;gap:10px;justify-content:flex-end;margin-top:14px}
    .modal input, .modal textarea{width:100%;padding:10px;border:1px solid #e2e8f0;border-radius:8px;color:#111 !important;background:#fff !important;}
    .modal input::placeholder, .modal textarea::placeholder{color:#555 !important; opacity: 1;}
    .modal small{color:#64748b}

    /* Mobile responsive */
    @media (max-width: 768px) {
      body { padding: 10px; }
      .container { max-width: 100%; border-radius: 10px; }
      .content { padding: 16px; }
      .header { padding: 22px 16px; }
      .header h1 { font-size: 1.6rem; line-height: 1.2; }
      .project-info-grid { grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 14px; }
      .upload-button { width: 100%; justify-content: center; font-size: 1rem; padding: 14px; }
      .tabs { flex-wrap: wrap; gap: 6px; }
      .tab { flex: 1 1 auto; text-align: center; padding: 12px; font-size: 0.95rem; }
      .categories-grid { grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 16px; }
      .photos-grid { grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 18px; }
      .photo-container { height: min(56vw, 340px); }
      .photo-details { flex-direction: column; gap: 8px; }
      .export-section { padding: 20px; margin-top: 24px; }
      .export-button { width: 100%; padding: 14px; font-size: 1rem; }
      .toast { top: auto; bottom: 18px; right: 18px; max-width: calc(100vw - 36px); }
      .modal { width: 100%; max-width: 520px; margin: 0 12px; }
    }

    @media (max-width: 420px) {
      .header h1 { font-size: 1.4rem; }
      .categories-grid, .photos-grid { grid-template-columns: 1fr; }
      .photo-container { height: min(62vw, 320px); }
    }

    @supports (padding: max(0px)) {
      body { padding-left: max(10px, env(safe-area-inset-left)); padding-right: max(10px, env(safe-area-inset-right)); }
      .toast { bottom: max(18px, env(safe-area-inset-bottom)); right: max(18px, env(safe-area-inset-right)); }
    }

    .empty-state{text-align:center;padding:40px;color:#6b7280}
    .empty-state i{font-size:48px;margin-bottom:16px;display:block}
    .empty-state h3{margin-bottom:8px}
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="logo-container">
        <img class="logo" alt="Equans" src="https://upload.wikimedia.org/wikipedia/fr/0/0c/Equans_Logo.png">
      </div>
      <h1><i class="fas fa-camera"></i> Reportage Photos T&C</h1>
      <p>Capturez et organisez vos photos (Tests L3, L4, BMS, etc.) par catégorie, puis générez en un clic des rapports PDF professionnels et de haute qualité.</p>
    </div>

    <div class="content">
      <div class="project-info-section">
        <h3 class="project-info-title"><i class="fas fa-info-circle"></i> Informations du projet</h3>
        <div class="project-info-grid">
          <div class="info-field"><label for="affaire"><i class="fas fa-building"></i> Affaire :</label><input id="affaire" placeholder="Ex: GSW PAR E Data Centre"></div>
          <div class="info-field"><label for="code"><i class="fas fa-barcode"></i> Code :</label><input id="code" placeholder="Ex: P 1 1 8 6"></div>
          <div class="info-field"><label for="agence"><i class="fas fa-map-marker-alt"></i> Agence :</label><input id="agence" placeholder="Ex: Agence Génie Climatique"></div>
          <div class="info-field"><label for="rapportType"><i class="fas fa-file-alt"></i> Type de rapport :</label><input id="rapportType" placeholder="Ex: Functional testing"></div>
          <div class="info-field"><label for="essais"><i class="fas fa-flask"></i> Essais :</label><input id="essais" placeholder="Ex: L4"></div>
          <div class="info-field"><label for="rmu"><i class="fas fa-door-open"></i> Salle :</label><input id="rmu" placeholder="Ex: HV/LV RMU L3D"></div>
          <div class="info-field"><label for="testScenario"><i class="fas fa-list-check"></i> Test scenario :</label><input id="testScenario" placeholder="Ex: TECHNICAL SUITE Heat Load Test"></div>
          <div class="info-field"><label for="testPurpose"><i class="fas fa-bullseye"></i> Test purpose :</label><input id="testPurpose" placeholder="Ex: Verification of proper behaviour of the FANWALL"></div>
          <div class="info-field"><label for="procedureVersion"><i class="fas fa-hashtag"></i> Procédure – Version :</label><input id="procedureVersion" placeholder="Ex: 1"></div>
          <div class="info-field"><label for="panelTitle"><i class="fas fa-layer-group"></i> Panel/Bloc title :</label><input id="panelTitle" placeholder="Ex: FANWALLs"></div>
          <div class="info-field"><label for="coverCategory"><i class="fas fa-tags"></i> Category (texte) :</label><input id="coverCategory" placeholder="Ex: Mechanical"></div>
          <div class="info-field"><label for="siteReference"><i class="fas fa-location-dot"></i> Site reference :</label><input id="siteReference" placeholder="Ex: TS-L3D / Room 12"></div>
          <div class="info-field"><label for="commissioningDate"><i class="fas fa-calendar-day"></i> Commissioning date :</label><input id="commissioningDate" type="date"></div>
          <div class="info-field"><label for="commissioningStart"><i class="fas fa-clock"></i> Start time :</label><input id="commissioningStart" type="time"></div>
          <div class="info-field"><label for="commissioningEnd"><i class="fas fa-clock"></i> End time :</label><input id="commissioningEnd" type="time"></div>
        </div>
      </div>

      <div id="uploadSection" class="upload-section">
        <h3><i class="fas fa-cloud-upload-alt"></i> Capturer ou Importer des photos</h3>
        <p>Faites une capture d'écran, utilisez la caméra ou importez des photos</p>
        <div style="display:flex;justify-content:center;gap:12px;flex-wrap:wrap;margin-top:14px">
          <button class="upload-button" onclick="document.getElementById('photoInput').click()"><i class="fas fa-folder-open"></i> Choisir des photos</button>
          <button class="upload-button" onclick="openCamera()"><i class="fas fa-camera"></i> Prendre une photo</button>
          <button class="upload-button" onclick="captureScreenshot()"><i class="fas fa-desktop"></i> Capture d'écran</button>
          <button class="upload-button" onclick="captureContainer()" title="Capture de l'interface"><i class="fas fa-square"></i> Capture de l'interface</button>
        </div>
        <input id="photoInput" type="file" accept="image/*" multiple style="display:none"/>
      </div>

      <div class="tabs">
        <button class="tab active" onclick="switchTab('categories')">Catégories</button>
        <button class="tab" onclick="switchTab('photos')">Toutes les photos</button>
      </div>

      <div id="categoriesTab" class="tab-content active">
        <div class="categories-section">
          <h3 class="section-title"><i class="fas fa-tasks"></i> Organisez vos photos par catégories</h3>
          <div id="categoriesGrid" class="categories-grid"></div>
        </div>
      </div>

      <div id="photosTab" class="tab-content">
        <div class="photos-container">
          <div id="photosContainer">
            <div class="empty-state">
              <i class="fas fa-camera"></i>
              <h3>Aucune photo importée</h3>
              <p>Importez, prenez une photo ou utilisez la capture d'écran.</p>
            </div>
          </div>
        </div>
      </div>

      <div id="exportSection" class="export-section" style="display:none">
        <div id="photoCount" class="photo-count">0 photos importées</div>
        <button id="exportButton" class="export-button" onclick="exportToPDF()"><i class="fas fa-file-pdf"></i> Générer le rapport PDF professionnel</button>
        
        <div class="pdf-options">
          <h4><i class="fas fa-cog"></i> Options PDF</h4>
          <div class="option-row">
            <input id="validateFields" type="checkbox" checked>
            <label for="validateFields">Vérifier que tous les champs sont remplis</label>
          </div>
          <div class="option-row">
            <input id="includeTableOfContents" type="checkbox" checked>
            <label for="includeTableOfContents">Inclure une table des matières</label>
          </div>
          <div class="option-row">
            <input id="groupByCategory" type="checkbox" checked>
            <label for="groupByCategory">Grouper les photos par catégorie</label>
          </div>
          <div class="option-row">
            <input id="showPhotoDetails" type="checkbox" checked>
            <label for="showPhotoDetails">Afficher les détails sous chaque photo</label>
          </div>
          <div class="option-row">
            <input id="highQuality" type="checkbox" checked>
            <label for="highQuality">Haute qualité d'image (fichier plus volumineux)</label>
          </div>
          <div class="option-row">
            <input id="zipPackage" type="checkbox" checked>
            <label for="zipPackage">Télécharger un ZIP (PDF à la racine + photos rangées par catégorie)</label>
          </div>
        </div>
      </div>

      <div id="loadingSection" class="loading">
        <div class="spinner"></div>
        <p>Génération du rapport professionnel en cours...</p>
        <div class="progress-bar"><div id="progressBar" class="progress"></div></div>
      </div>
    </div>
  </div>

  <!-- Camera modal -->
  <div id="cameraModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.92);z-index:2000;align-items:center;justify-content:center">
    <div style="background:#fff;border-radius:12px;max-width:800px;width:90%;padding:20px">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
        <h3><i class="fas fa-camera"></i> Appareil photo</h3>
        <button onclick="closeCamera()" style="background:#e74c3c;color:#fff;border:none;width:36px;height:36px;border-radius:50%;cursor:pointer">×</button>
      </div>
      <div style="height:420px;background:#111;border-radius:8px;position:relative;overflow:hidden">
        <video id="cameraFeed" autoplay playsinline style="width:100%;height:100%;object-fit:contain"></video>
        <div id="photoCounter" style="position:absolute;top:10px;left:10px;background:rgba(0,0,0,.6);color:#fff;padding:6px 12px;border-radius:20px;font-size:.9rem">0 photo(s)</div>
      </div>
      <div style="display:flex;gap:12px;justify-content:center;margin-top:14px;flex-wrap:wrap">
        <button id="switchCameraBtn" class="upload-button" type="button" title="Basculer avant/arrière">
          <i class="fas fa-sync-alt"></i> Changer caméra (<span id="facingLabel">Arrière</span>)
        </button>
        <button id="captureButton" class="upload-button" type="button">
          <i class="fas fa-camera"></i> Prendre la photo
        </button>
        <button class="upload-button" style="background:#e5e7eb;color:#111" type="button" onclick="closeCamera()">
          <i class="fas fa-times"></i> Annuler
        </button>
      </div>
    </div>
  </div>

  <!-- Modal Catégorie -->
  <div id="categoryModalOverlay" class="modal-overlay">
    <div class="modal">
      <header>
        <h3><i class="fas fa-tags"></i> Catégorie</h3>
        <button onclick="closeCategoryModal()" style="background:#e74c3c;color:#fff;border:none;width:36px;height:36px;border-radius:50%;cursor:pointer">×</button>
      </header>
      <input id="catId" type="hidden">
      <div class="info-field">
        <label for="catName">Nom de la catégorie :</label>
        <input id="catName" placeholder="Ex: Water Leak Test">
      </div>
      <div class="info-field" style="margin-top:10px">
        <label for="catIcon">Icône (classe Font Awesome) :</label>
        <input id="catIcon" placeholder="Ex: fas fa-tint">
        <small>Astuce : <code>fas fa-bolt</code>, <code>fas fa-plug</code>, <code>fas fa-fire-extinguisher</code>…</small>
      </div>
      <div class="info-field" style="margin-top:10px">
        <label for="catDesc">Description :</label>
        <textarea id="catDesc" rows="3" placeholder="Texte d'aide affiché sous le titre"></textarea>
      </div>
      <div class="actions">
        <button class="upload-button" style="background:#e5e7eb;color:#111" onclick="closeCategoryModal()">
          <i class="fas fa-times"></i> Annuler
        </button>
        <button class="upload-button" onclick="saveCategoryFromModal()">
          <i class="fas fa-check"></i> Enregistrer
        </button>
      </div>
    </div>
  </div>

  <script>
    // ===== Globals
    let photos = [];
    let photoCounter = 0;
    let activeTab = 'categories';
    let stream = null;
    let facingMode = "environment";
    let pendingAssignPhotoId = null;

    // Catégories par défaut
    const defaultCategories = [
      { id:'etat_initial', name:'État initial', icon:'fas fa-flag', description:"Photos de l'état initial du chantier" },
      { id:'fire_detection', name:'Fire Detection', icon:'fas fa-fire-extinguisher', description:'Système de détection incendie' },
      { id:'first_functional_test', name:'First Functional Test', icon:'fas fa-wrench', description:'Premier test fonctionnel des équipements' },
      { id:'increasing_electrical_charge', name:'Increasing Electrical Charge', icon:'fas fa-bolt', description:'Augmentation progressive de la charge électrique' },
      { id:'loss_crah_redundancy', name:'Loss of CRAH redundancy', icon:'fas fa-server', description:'Perte de redondance CRAH dans RMU' },
      { id:'power_failure_crah', name:'Power failure of CRAH-C', icon:'fas fa-plug', description:"Panne d'alimentation CRAH-C et perte CRAC" },
      { id:'probes_loss_test', name:'Probes Loss Test', icon:'fas fa-thermometer-half', description:'Test de perte de sondes' }
    ];

    // Chargement des catégories
    let categories = (() => {
      try {
        const saved = localStorage.getItem('photo_categories_v1');
        return saved ? JSON.parse(saved) : defaultCategories;
      } catch { 
        return defaultCategories; 
      }
    })();

    function saveCategories(){ 
      try{ 
        localStorage.setItem('photo_categories_v1', JSON.stringify(categories)); 
      } catch(e) { 
        console.log('LocalStorage non disponible'); 
      } 
    }

    // ===== Initialisation
    document.addEventListener('DOMContentLoaded', () => {
      console.log('DOM chargé, initialisation...');
      
      const photoInput = document.getElementById('photoInput');
      const uploadSection = document.getElementById('uploadSection');
      const captureButton = document.getElementById('captureButton');
      
      if (!photoInput || !uploadSection) {
        console.error('Éléments essentiels manquants');
        return;
      }

      // Event listeners
      photoInput.addEventListener('change', e => processFiles(e.target.files));
      uploadSection.addEventListener('dragover', e => e.preventDefault());
      uploadSection.addEventListener('drop', e => { 
        e.preventDefault(); 
        processFiles(e.dataTransfer.files); 
      });
      
      if (captureButton) {
        captureButton.addEventListener('click', capturePhoto);
      }

      // Bouton changement de caméra
      const switchCameraBtn = document.getElementById('switchCameraBtn');
      if (switchCameraBtn) {
        switchCameraBtn.addEventListener('click', async () => {
          facingMode = (facingMode === 'user') ? 'environment' : 'user';
          await startCamera();
        });
      }

      renderCategories();
      updatePhotoCount();
      
      console.log('Initialisation terminée');
    });

    // ===== UI helpers
    function showToast(msg, type='') { 
      console.log(`Toast: ${msg} (${type})`);
      const t = document.createElement('div'); 
      t.className = `toast ${type}`; 
      t.textContent = msg; 
      document.body.appendChild(t); 
      setTimeout(() => t.classList.add('show'), 10); 
      setTimeout(() => { 
        t.classList.remove('show'); 
        setTimeout(() => t.remove(), 250) 
      }, 3500); 
    }
    
    function switchTab(tab) { 
      console.log(`Basculement vers l'onglet: ${tab}`);
      activeTab = tab; 
      document.querySelectorAll('.tab').forEach(b => b.classList.remove('active')); 
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active')); 
      
      const tabButton = document.querySelector(`[onclick="switchTab('${tab}')"]`);
      const tabContent = document.getElementById(tab + 'Tab');
      
      if (tabButton) tabButton.classList.add('active'); 
      if (tabContent) tabContent.classList.add('active'); 
      
      if (tab === 'photos') renderPhotos(); 
      else renderCategories(); 
    }
    
    function selectCategory(id) { 
      console.log(`Sélection de la catégorie: ${id}`);
      switchTab('photos'); 
      renderPhotos(id); 
    }
    
    function updatePhotoCount() { 
      const el = document.getElementById('photoCount'); 
      const count = photos.length;
      if (el) {
        el.textContent = `${count} photo${count > 1 ? 's' : ''} importée${count > 1 ? 's' : ''}`;
      }
      
      // Afficher la section d'export s'il y a des photos
      const exportSection = document.getElementById('exportSection');
      if (exportSection) {
        exportSection.style.display = count > 0 ? 'block' : 'none';
      }
    }

    // ===== Camera functions
    async function startCamera() {
      console.log(`Démarrage caméra, mode: ${facingMode}`);
      
      if (stream) { 
        stream.getTracks().forEach(t => t.stop()); 
        stream = null; 
      }

      const constraintsBase = {
        video: {
          width: { ideal: 1280 },
          height: { ideal: 720 },
          facingMode: { ideal: facingMode }
        },
        audio: false
      };

      try {
        stream = await navigator.mediaDevices.getUserMedia(constraintsBase);
        console.log('Stream caméra obtenu avec succès');
      } catch (e) {
        console.log('Échec avec contraintes spécifiques, tentative basique');
        try {
          stream = await navigator.mediaDevices.getUserMedia({ video: true });
        } catch (e2) {
          console.error('Impossible d\'obtenir un stream caméra', e2);
          throw e2;
        }
      }

      const video = document.getElementById("cameraFeed");
      if (video) {
        video.srcObject = stream;
      }
      
      const label = document.getElementById("facingLabel");
      if (label) {
        label.textContent = facingMode === "user" ? "Avant" : "Arrière";
      }
    }

    async function openCamera() {
      console.log('Ouverture de la caméra');
      const modal = document.getElementById('cameraModal');
      if (!modal) {
        showToast("Modal caméra introuvable", 'error');
        return;
      }
      
      modal.style.display = 'flex';
      
      try {
        await startCamera();
        showToast("Caméra démarrée", 'success');
      } catch (e) {
        console.error('Erreur caméra:', e);
        showToast("Impossible d'accéder à la caméra", 'error');
        closeCamera();
      }
    }

    function closeCamera() {
      console.log('Fermeture de la caméra');
      const modal = document.getElementById('cameraModal');
      if (modal) {
        modal.style.display = 'none';
      }
      
      if (stream) { 
        stream.getTracks().forEach(t => t.stop()); 
        stream = null; 
      }
    }
    
    function capturePhoto() { 
      console.log('Capture de photo');
      const v = document.getElementById('cameraFeed');
      if (!v || !v.videoWidth) {
        showToast('Caméra non prête', 'error');
        return;
      }
      
      const c = document.createElement('canvas'); 
      c.width = v.videoWidth; 
      c.height = v.videoHeight; 
      c.getContext('2d').drawImage(v, 0, 0); 
      
      c.toBlob(async b => { 
        const f = new File([b], `photo-${ts()}.jpg`, {type: 'image/jpeg'}); 
        await addPhoto(f); 
        showToast('Photo ajoutée', 'success'); 
        updatePhotoCounter();
      }, 'image/jpeg', 0.9); 
    }

    function updatePhotoCounter() {
      const counter = document.getElementById('photoCounter');
      if (counter) {
        counter.textContent = `${photos.length} photo(s)`;
      }
    }

    // ===== Screen capture
    async function captureScreenshot() {
      console.log('Démarrage capture d\'écran');
      
      if (!navigator.mediaDevices || !navigator.mediaDevices.getDisplayMedia) {
        showToast('Capture d\'écran non supportée', 'error');
        return;
      }
      
      try {
        const displayStream = await navigator.mediaDevices.getDisplayMedia({ 
          video: {cursor: 'always'}, 
          audio: false 
        });
        
        showToast('Capture dans 3 secondes… basculez sur la fenêtre choisie');
        await new Promise(r => setTimeout(r, 3000));
        
        const [track] = displayStream.getVideoTracks();
        let blob;
        
        if ('ImageCapture' in window) {
          try {
            const cap = new ImageCapture(track);
            const bitmap = await cap.grabFrame();
            const c = document.createElement('canvas'); 
            c.width = bitmap.width; 
            c.height = bitmap.height; 
            c.getContext('2d').drawImage(bitmap, 0, 0);
            blob = await new Promise(res => c.toBlob(res, 'image/png', 0.92));
          } catch {
            blob = await frameFromVideo(displayStream);
          }
        } else { 
          blob = await frameFromVideo(displayStream); 
        }
        
        displayStream.getTracks().forEach(t => t.stop());
        
        const f = new File([blob], `screenshot-${ts()}.png`, {type: 'image/png'}); 
        await addPhoto(f); 
        showToast("Capture d'écran ajoutée", 'success'); 
        
        if (activeTab === 'photos') renderPhotos(); 
        else renderCategories(); 
        updatePhotoCount();
        
      } catch(e) { 
        console.log('Capture annulée ou erreur:', e);
        showToast("Capture d'écran annulée ou refusée", 'warning'); 
      }
    }
    
    async function frameFromVideo(stream) { 
      const v = document.createElement('video'); 
      v.srcObject = stream; 
      v.playsInline = true; 
      await v.play(); 
      await new Promise(r => requestAnimationFrame(r)); 
      
      const c = document.createElement('canvas'); 
      c.width = v.videoWidth; 
      c.height = v.videoHeight; 
      c.getContext('2d').drawImage(v, 0, 0); 
      return await new Promise(res => c.toBlob(res, 'image/png', 0.92)); 
    }

    // ===== Capture UI container
    async function captureContainer() { 
      console.log('Capture de l\'interface');
      
      if (typeof html2canvas === 'undefined') {
        showToast('html2canvas non chargé', 'error');
        return;
      }
      
      const el = document.querySelector('.container'); 
      if (!el) {
        showToast('Container non trouvé', 'error');
        return;
      }
      
      try {
        const canvas = await html2canvas(el, {
          useCORS: true, 
          scale: 2, 
          backgroundColor: '#fff'
        }); 
        
        const blob = await new Promise(res => canvas.toBlob(res, 'image/png', 0.92)); 
        const f = new File([blob], `interface-${ts()}.png`, {type: 'image/png'}); 
        await addPhoto(f); 
        showToast("Capture interface ajoutée", 'success'); 
        
        if (activeTab === 'photos') renderPhotos(); 
        else renderCategories(); 
        updatePhotoCount();
        
      } catch(e) {
        console.error('Erreur capture interface:', e);
        showToast('Erreur capture interface', 'error');
      }
    }

    // ===== Photo management
    async function processFiles(files) {
      console.log(`Traitement de ${files.length} fichier(s)`);
      
      if (!files || files.length === 0) {
        showToast('Aucun fichier sélectionné', 'warning');
        return;
      }
      
      let addedCount = 0;
      for (const file of files) {
        if (!file.type.startsWith('image/')) { 
          showToast(`${file.name}: Format non supporté`, 'error'); 
          continue; 
        }
        if (file.size > 5 * 1024 * 1024) { 
          showToast(`${file.name}: Fichier > 5 Mo`, 'error'); 
          continue; 
        }
        
        try {
          await addPhoto(file);
          addedCount++;
        } catch(e) {
          console.error('Erreur ajout photo:', e);
          showToast(`Erreur ajout ${file.name}`, 'error');
        }
      }
      
      if (addedCount > 0) {
        showToast(`${addedCount} photo(s) ajoutée(s)`, 'success');
        if (activeTab === 'photos') renderPhotos(); 
        else renderCategories();
        updatePhotoCount();
      }
    }
    
    function addPhoto(file) { 
      console.log(`Ajout de la photo: ${file.name}`);
      return new Promise((resolve, reject) => {
        const r = new FileReader(); 
        r.onload = e => {
          const now = new Date(); 
          photos.push({ 
            id: ++photoCounter, 
            file, 
            dataUrl: e.target.result, 
            designation: `Photo ${photoCounter}`, 
            filename: file.name, 
            category: 'etat_initial', 
            stepNumber: photoCounter, 
            date: now.toISOString().split('T')[0], 
            time: now.toTimeString().slice(0, 5), 
            rotation: 0 
          }); 
          resolve(); 
        }; 
        r.onerror = reject;
        r.readAsDataURL(file); 
      }); 
    }
    
    function rotatePhoto(id) { 
      console.log(`Rotation photo ${id}`);
      const p = photos.find(x => x.id === id); 
      if (p) { 
        p.rotation = (p.rotation + 90) % 360; 
        renderPhotos(); 
      } 
    }
    
    function updateDesignation(id, v) { 
      const p = photos.find(x => x.id === id); 
      if (p) { 
        p.designation = v; 
      } 
    }

    function updateCategory(id, v) {
      const p = photos.find(x => x.id === id);
      if (!p) return;
      
      if (v === '__new__') {
        pendingAssignPhotoId = id;
        openCategoryModal();
        renderPhotos(); // remettre l'ancien choix visuellement
        return;
      }
      
      p.category = v; 
      renderPhotos(); 
      renderCategories();
    }

    function updateStepNumber(id, v) { 
      const p = photos.find(x => x.id === id); 
      if (p) { 
        p.stepNumber = parseInt(v) || 0; 
      } 
    }
    
    function updateDate(id, v) { 
      const p = photos.find(x => x.id === id); 
      if (p) { 
        p.date = v; 
      } 
    }
    
    function updateTime(id, v) { 
      const p = photos.find(x => x.id === id); 
      if (p) { 
        p.time = v; 
      } 
    }
    
    function removePhoto(id) { 
      if (!confirm('Supprimer cette photo ?')) return; 
      
      console.log(`Suppression photo ${id}`);
      photos = photos.filter(p => p.id !== id); 
      renderPhotos(); 
      renderCategories(); 
      updatePhotoCount(); 
      showToast('Photo supprimée', 'success');
    }

    // === Helpers Catégories (modal + CRUD)
    function slugify(t) {
      return t.toLowerCase().trim()
        .replace(/[^a-z0-9]+/g, '_')
        .replace(/^_+|_+$/g, '')
        .slice(0, 60);
    }

    function openCategoryModal(editId = null) {
      console.log(`Ouverture modal catégorie, edit: ${editId}`);
      const overlay = document.getElementById('categoryModalOverlay');
      if (!overlay) {
        showToast('Modal catégorie non trouvée', 'error');
        return;
      }
      
      const isEdit = !!editId;
      const c = isEdit ? categories.find(x => x.id === editId) : {
        id: '', 
        name: '', 
        icon: 'fas fa-tag', 
        description: ''
      };
      
      document.getElementById('catId').value = c.id || '';
      document.getElementById('catName').value = c.name || '';
      document.getElementById('catIcon').value = c.icon || 'fas fa-tag';
      document.getElementById('catDesc').value = c.description || '';
      
      overlay.style.display = 'flex';
    }

    function closeCategoryModal() {
      const overlay = document.getElementById('categoryModalOverlay');
      if (overlay) {
        overlay.style.display = 'none';
      }
      pendingAssignPhotoId = null;
    }

    function saveCategoryFromModal() {
      const idInput = document.getElementById('catId').value;
      const name = (document.getElementById('catName').value || '').trim();
      const icon = (document.getElementById('catIcon').value || 'fas fa-tag').trim();
      const description = (document.getElementById('catDesc').value || '').trim();

      if (!name) { 
        showToast('Nom de catégorie requis', 'error'); 
        return; 
      }

      let id = idInput || slugify(name);
      let base = id, i = 2;
      while (categories.some(c => c.id === id)) { 
        id = `${base}_${i++}`; 
      }

      if (idInput) {
        // Modification
        const idx = categories.findIndex(c => c.id === idInput);
        if (idx > -1) { 
          categories[idx] = { id: idInput, name, icon, description }; 
        }
      } else {
        // Création
        categories.push({ id, name, icon, description });
      }
      
      saveCategories();

      // Assignation en attente
      if (pendingAssignPhotoId) {
        const p = photos.find(x => x.id === pendingAssignPhotoId);
        if (p) { 
          p.category = idInput || id; 
        }
      }

      closeCategoryModal();
      renderCategories();
      renderPhotos();
      showToast('Catégorie enregistrée', 'success');
    }

    function deleteCategory(id) {
      if (!confirm('Supprimer cette catégorie ? Les photos seront réassignées à "État initial".')) return;
      
      console.log(`Suppression catégorie ${id}`);
      photos.forEach(p => { 
        if (p.category === id) p.category = 'etat_initial'; 
      });
      categories = categories.filter(c => c.id !== id);
      saveCategories(); 
      renderCategories(); 
      renderPhotos();
      showToast('Catégorie supprimée', 'success');
    }

    // === Rendu
    function renderCategories() {
      console.log('Rendu des catégories');
      const container = document.getElementById('categoriesGrid');
      if (!container) {
        console.error('Container catégories non trouvé');
        return;
      }
      
      const cards = categories.map(cat => {
        const items = photos.filter(p => p.category === cat.id);
        return `<div class="category-card ${items.length ? 'selected' : ''}" onclick="selectCategory('${cat.id}')">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
            <div style="font-weight:700;color:#083344"><i class="${cat.icon}"></i> ${cat.name}</div>
            <div style="display:flex;align-items:center;gap:8px">
              <span style="background:#5fa586;color:#fff;padding:4px 10px;border-radius:14px;font-weight:600">${items.length}</span>
              <button onclick="event.stopPropagation(); openCategoryModal('${cat.id}')" class="control-btn" title="Modifier"><i class="fas fa-pen"></i></button>
              ${cat.id !== 'etat_initial' ? `<button onclick="event.stopPropagation(); deleteCategory('${cat.id}')" class="control-btn" title="Supprimer"><i class="fas fa-trash"></i></button>` : ''}
            </div>
          </div>
          <div style="color:#6b7280">${cat.description || ''}</div>
        </div>`;
      });

      // carte "Ajouter une catégorie"
      cards.push(`<div class="category-card add-card" onclick="openCategoryModal()">
        <div style="font-weight:700;margin-bottom:8px"><i class="fas fa-plus-circle"></i> Ajouter une catégorie</div>
        <div style="color:#6b7280">Créez une catégorie personnalisée (nom, icône, description)</div>
      </div>`);

      container.innerHTML = cards.join('');
    }

    function renderPhotos(filterCategory = null) {
      console.log(`Rendu des photos, filtre: ${filterCategory}`);
      const container = document.getElementById('photosContainer');
      if (!container) {
        console.error('Container photos non trouvé');
        return;
      }
      
      if (!photos.length) {
        container.innerHTML = `<div class="empty-state">
          <i class="fas fa-camera"></i>
          <h3>Aucune photo importée</h3>
          <p>Importez, prenez une photo ou utilisez la capture d'écran.</p>
        </div>`;
        return;
      }
      
      let list = [...photos].sort((a, b) => a.stepNumber - b.stepNumber);
      if (filterCategory) {
        list = list.filter(p => p.category === filterCategory);
        if (list.length === 0) {
          container.innerHTML = `<div class="empty-state">
            <i class="fas fa-camera"></i>
            <h3>Aucune photo dans cette catégorie</h3>
          </div>`;
          return;
        }
      }

      const html = list.map(p => {
        const catName = categories.find(c => c.id === p.category)?.name || 'Non assignée';
        const opts = [
          ...categories.map(c => `<option value="${c.id}" ${p.category === c.id ? 'selected' : ''}>${c.name}</option>`),
          `<option value="__new__">➕ Nouvelle catégorie…</option>`
        ].join('');
        
        return `<div class="photo-item">
          <div class="photo-container">
            <img class="photo-img" src="${p.dataUrl}" style="transform:rotate(${p.rotation}deg)" alt="${p.designation}"/>
            <div class="category-badge"><i class="fas fa-folder"></i> ${catName}</div>
            <div class="photo-controls">
              <button class="control-btn" onclick="rotatePhoto(${p.id})" title="Rotation"><i class="fas fa-sync-alt"></i></button>
              <button class="control-btn" onclick="removePhoto(${p.id})" title="Supprimer"><i class="fas fa-trash"></i></button>
            </div>
          </div>
          <div class="photo-info">
            <input value="${p.designation}" onchange="updateDesignation(${p.id}, this.value)" placeholder="Description de la photo">
            <select onchange="updateCategory(${p.id}, this.value)">${opts}</select>
            <div class="photo-details">
              <input type="number" value="${p.stepNumber}" onchange="updateStepNumber(${p.id}, this.value)" placeholder="N° étape" min="0">
              <input type="date" value="${p.date}" onchange="updateDate(${p.id}, this.value)">
              <input type="time" value="${p.time}" onchange="updateTime(${p.id}, this.value)">
            </div>
          </div>
        </div>`;
      }).join('');
      
      container.innerHTML = `<div class="photos-grid">${html}</div>`;
    }

    // ===== Helpers ZIP & noms de fichiers
    function sanitize(s) {
      return (s || '').normalize('NFKD')
        .replace(/[\u0300-\u036f]/g, '')
        .replace(/[^a-z0-9\-_\s]/gi, '')
        .trim()
        .replace(/\s+/g, '_');
    }

    function dataURLtoBlob(dataurl) {
      const [head, body] = dataurl.split(',');
      const mime = head.match(/:(.*?);/)[1];
      const bstr = atob(body);
      const u8 = new Uint8Array(bstr.length);
      for (let i = 0; i < bstr.length; i++) u8[i] = bstr.charCodeAt(i);
      return new Blob([u8], {type: mime});
    }

    async function getPhotoBlobWithRotation(photo) {
      return new Promise(resolve => {
        const img = new Image();
        img.onload = () => {
          const angle = (photo.rotation || 0) % 360;
          let w = img.width, h = img.height;
          const canvas = document.createElement('canvas');
          
          if (angle === 90 || angle === 270) { 
            canvas.width = h; 
            canvas.height = w; 
          } else { 
            canvas.width = w; 
            canvas.height = h; 
          }
          
          const ctx = canvas.getContext('2d');
          if (angle) {
            ctx.translate(canvas.width / 2, canvas.height / 2);
            ctx.rotate(angle * Math.PI / 180);
            ctx.drawImage(img, -w / 2, -h / 2);
          } else {
            ctx.drawImage(img, 0, 0);
          }
          
          canvas.toBlob(b => resolve(b), 'image/jpeg', 0.92);
        };
        img.onerror = () => resolve(dataURLtoBlob(photo.dataUrl));
        img.src = photo.dataUrl;
      });
    }

    async function exportZipWithPhotos(pdfBlob, pdfFileName) {
      console.log('Création du ZIP avec photos');
      
      if (typeof JSZip === 'undefined') {
        showToast('JSZip non chargé', 'error');
        return;
      }
      
      const zip = new JSZip();
      const rootName = sanitize(pdfFileName.replace(/\.pdf$/, ''));
      const root = zip.folder(rootName);

      // 1) PDF à la racine
      root.file(pdfFileName, pdfBlob);

      // 2) Dossiers par catégorie
      const folderByCat = {};
      categories.forEach(c => folderByCat[c.id] = root.folder(sanitize(c.name)));

      // 3) Photos renommées
      for (const p of photos) {
        const folder = folderByCat[p.category] || root.folder('Non_classee');
        const step = String(p.stepNumber || 0).padStart(3, '0');
        const date = (p.date || '').trim();
        const time = (p.time || '').replace(':', '-');
        const base = sanitize(p.designation || `Photo_${p.id}`);
        const fname = `Step-${step}_${date}${time ? `_${time}` : ''}_${base}.jpg`;
        const blob = await getPhotoBlobWithRotation(p);
        folder.file(fname, blob);
      }

      // 4) Génère et télécharge le ZIP
      const zipBlob = await zip.generateAsync({type: 'blob'});
      
      if (typeof saveAs !== 'undefined') {
        saveAs(zipBlob, `${rootName}.zip`);
      } else {
        // Fallback sans FileSaver.js
        const url = URL.createObjectURL(zipBlob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${rootName}.zip`;
        a.click();
        URL.revokeObjectURL(url);
      }
    }

    // ===== PDF helpers
    function getCategoryName(id) { 
      return (categories.find(c => c.id === id)?.name) || 'Non classée'; 
    }
    
    function formatDate(dateStr) { 
      if (!dateStr) return ''; 
      const [y, m, d] = dateStr.split('-'); 
      return `${d}/${m}/${y}`; 
    }
    
    function formatTime(timeStr) { 
      return timeStr || ''; 
    }

    async function addCoverPage(pdf, info) {
      const pageW = pdf.internal.pageSize.getWidth();
      const pageH = pdf.internal.pageSize.getHeight();
      const margin = 15;
      const blue = {r: 25, g: 72, b: 78};

      pdf.setFillColor(blue.r, blue.g, blue.b);
      pdf.rect(0, 0, pageW, 50, 'F');
      
      try {
        const eq = new Image(); 
        eq.crossOrigin = 'anonymous'; 
        eq.src = 'https://upload.wikimedia.org/wikipedia/fr/0/0c/Equans_Logo.png'; 
        await new Promise(r => {eq.onload = r; eq.onerror = r}); 
        pdf.addImage(eq, 'PNG', margin, 10, 50, 16);
      } catch(e) {
        console.log('Logo non chargé');
      }
      
      pdf.setTextColor(255, 255, 255);
      pdf.setFont('helvetica', 'bold'); 
      pdf.setFontSize(28);
      pdf.text('RAPPORT PHOTO TECHNIQUE', pageW / 2, 35, {align: 'center'});

      let y = 70;
      pdf.setFillColor(248, 249, 250);
      pdf.rect(margin, y, pageW - 2 * margin, 80, 'F');
      pdf.setDrawColor(200);
      pdf.rect(margin, y, pageW - 2 * margin, 80);

      pdf.setTextColor(blue.r, blue.g, blue.b);
      pdf.setFontSize(16); 
      pdf.setFont('helvetica', 'bold');
      pdf.text('INFORMATIONS PROJET', margin + 10, y + 15);

      y += 25;
      pdf.setTextColor(0); 
      pdf.setFontSize(12); 
      pdf.setFont('helvetica', 'normal');

      const leftCol = margin + 10;
      const rightCol = pageW / 2 + 10;
      const lineHeight = 12;

      // Informations projet
      const projectInfo = [
        ['Affaire:', info.affaire || 'Non spécifié'],
        ['Code:', info.code || 'Non spécifié'],
        ['Agence:', info.agence || 'Non spécifié']
      ];
      
      const rightInfo = [
        ['Type:', info.rapportType || 'Functional testing'],
        ['Date:', formatDate(info.commissioningDate) || new Date().toLocaleDateString('fr-FR')],
        ['Salle:', info.rmu || 'Non spécifié']
      ];

      projectInfo.forEach(([label, value], index) => {
        const currentY = y + (index * lineHeight);
        pdf.setFont('helvetica', 'bold');
        pdf.text(label, leftCol, currentY);
        pdf.setFont('helvetica', 'normal');
        pdf.text(value, leftCol + 25, currentY);
      });

      rightInfo.forEach(([label, value], index) => {
        const currentY = y + (index * lineHeight);
        pdf.setFont('helvetica', 'bold');
        pdf.text(label, rightCol, currentY);
        pdf.setFont('helvetica', 'normal');
        pdf.text(value, rightCol + 25, currentY);
      });

      y = 170;
      pdf.setFillColor(blue.r, blue.g, blue.b);
      pdf.rect(margin, y, pageW - 2 * margin, 30, 'F');
      pdf.setTextColor(255); 
      pdf.setFontSize(14); 
      pdf.setFont('helvetica', 'bold');
      pdf.text('RÉSUMÉ DU RAPPORT', margin + 10, y + 20);

      y += 40;
      pdf.setTextColor(0); 
      pdf.setFontSize(11); 
      pdf.setFont('helvetica', 'normal');
      const totalPhotos = photos.length;
      const categoriesUsed = [...new Set(photos.map(p => p.category))].length;
      pdf.text(`• Nombre total de photos: ${totalPhotos}`, margin + 10, y);
      pdf.text(`• Catégories utilisées: ${categoriesUsed}`, margin + 10, y + 12);
      pdf.text(`• Date de génération: ${new Date().toLocaleDateString('fr-FR')} à ${new Date().toLocaleTimeString('fr-FR')}`, margin + 10, y + 24);

      pdf.setFontSize(8); 
      pdf.setTextColor(100);
      pdf.text('Document généré automatiquement - Confidentiel', pageW / 2, pageH - 10, {align: 'center'});
    }

    async function addTableOfContents(pdf, categoryStats) {
      pdf.addPage();
      const pageW = pdf.internal.pageSize.getWidth();
      const margin = 15;

      pdf.setFillColor(25, 72, 78);
      pdf.rect(0, 0, pageW, 30, 'F');
      pdf.setTextColor(255);
      pdf.setFont('helvetica', 'bold'); 
      pdf.setFontSize(18);
      pdf.text('TABLE DES MATIÈRES', pageW / 2, 20, {align: 'center'});

      let y = 50;
      pdf.setTextColor(0);
      pdf.setFontSize(12);

      Object.keys(categoryStats).forEach((catId, index) => {
        const cat = categories.find(c => c.id === catId);
        const count = categoryStats[catId];
        if (count > 0 && cat) {
          pdf.setFont('helvetica', 'normal');
          pdf.text(`${index + 1}.`, margin, y);
          pdf.text(cat.name, margin + 15, y);
          pdf.text(`${count} photo${count > 1 ? 's' : ''}`, pageW - margin - 30, y);
          const dots = '.'.repeat(Math.floor((pageW - margin - 80 - pdf.getTextWidth(cat.name)) / 2));
          pdf.setTextColor(150);
          pdf.text(dots, margin + 15 + pdf.getTextWidth(cat.name) + 5, y);
          pdf.setTextColor(0);
          y += 15;
        }
      });
    }

    async function exportToPDF() {
      console.log('Démarrage export PDF');
      
      if (!photos.length) { 
        showToast('Aucune photo à exporter', 'error'); 
        return; 
      }
      
      if (document.getElementById('validateFields').checked && !validatePhotoFields()) { 
        showToast('Veuillez remplir tous les champs', 'error'); 
        highlightMissingFields(); 
        return; 
      }

      const loading = document.getElementById('loadingSection'); 
      const btn = document.getElementById('exportButton'); 
      const bar = document.getElementById('progressBar');
      
      if (!loading || !btn || !bar) {
        showToast('Éléments UI manquants', 'error');
        return;
      }
      
      loading.style.display = 'block'; 
      btn.disabled = true;

      try {
        if (typeof jsPDF === 'undefined') {
          showToast('jsPDF non chargé', 'error');
          return;
        }
        
        const { jsPDF } = window.jspdf; 
        const pdf = new jsPDF();
        const pageW = pdf.internal.pageSize.width;
        const pageH = pdf.internal.pageSize.height;
        const margin = 15;
        const headerH = 25;
        const footerH = 15;
        const contentH = pageH - headerH - footerH - margin * 2;

        bar.style.width = '5%';

        const info = {
          affaire: document.getElementById('affaire').value || '',
          code: document.getElementById('code').value || '',
          agence: document.getElementById('agence').value || '',
          rapportType: document.getElementById('rapportType').value || 'Functional testing',
          essais: document.getElementById('essais').value || 'L4',
          rmu: document.getElementById('rmu').value || '',
          testScenario: document.getElementById('testScenario').value || '',
          testPurpose: document.getElementById('testPurpose').value || '',
          procedureVersion: document.getElementById('procedureVersion').value || '1',
          panelTitle: document.getElementById('panelTitle').value || 'FANWALLs',
          coverCategory: document.getElementById('coverCategory').value || '',
          siteReference: document.getElementById('siteReference').value || '',
          commissioningDate: document.getElementById('commissioningDate').value || '',
          commissioningStart: document.getElementById('commissioningStart').value || '',
          commissioningEnd: document.getElementById('commissioningEnd').value || ''
        };

        await addCoverPage(pdf, info);
        bar.style.width = '15%';

        if (document.getElementById('includeTableOfContents').checked) {
          const categoryStats = {};
          categories.forEach(cat => { 
            categoryStats[cat.id] = photos.filter(p => p.category === cat.id).length; 
          });
          await addTableOfContents(pdf, categoryStats);
        }
        bar.style.width = '25%';

        const addHeader = (pageNum) => { 
          pdf.setFillColor(245, 245, 245); 
          pdf.rect(0, 0, pageW, headerH);
          pdf.setFontSize(10); 
          pdf.setTextColor(100); 
          pdf.setFont('helvetica', 'normal');
          pdf.text(`Rapport Photo - ${info.affaire || 'Projet'}`, margin, 12);
          pdf.text(`Page ${pageNum}`, pageW - margin, 12, {align: 'right'});
        };
        
        const addFooter = () => { 
          pdf.setFontSize(8); 
          pdf.setTextColor(150); 
          const d = new Date().toLocaleDateString('fr-FR'); 
          pdf.text(`Généré le ${d}`, margin, pageH - 5); 
          pdf.text(info.agence || 'Equans', pageW - margin, pageH - 5, {align: 'right'}); 
        };

        let photoGroups;
        if (document.getElementById('groupByCategory').checked) {
          photoGroups = {};
          categories.forEach(c => photoGroups[c.id] = []);
          photos.forEach(p => { 
            if (!photoGroups[p.category]) photoGroups[p.category] = []; 
            photoGroups[p.category].push(p); 
          });
          Object.keys(photoGroups).forEach(k => { 
            photoGroups[k].sort((a, b) => a.stepNumber - b.stepNumber); 
          });
        } else {
          photoGroups = { 'all': [...photos].sort((a, b) => a.stepNumber - b.stepNumber) };
        }

        let totalProgress = 35;
        const progressPerPhoto = 60 / Math.max(1, photos.length);

        for (const [groupKey, photoList] of Object.entries(photoGroups)) {
          if (!photoList.length) continue;
          const categoryInfo = categories.find(c => c.id === groupKey);
          let photoIndex = 0;

          while (photoIndex < photoList.length) {
            pdf.addPage();
            const currentPage = pdf.internal.getNumberOfPages();
            addHeader(currentPage);

            let yCursor = headerH + margin;

            if (document.getElementById('groupByCategory').checked && categoryInfo) {
              pdf.setFillColor(25, 72, 78);
              pdf.rect(margin, yCursor, pageW - 2 * margin, 20, 'F');
              pdf.setTextColor(255); 
              pdf.setFont('helvetica', 'bold'); 
              pdf.setFontSize(14);
              pdf.text(`${categoryInfo.name}`, margin + 8, yCursor + 13);
              yCursor += 25;
            }

            const photosOnThisPage = Math.min(2, photoList.length - photoIndex);
            for (let slot = 0; slot < photosOnThisPage; slot++) {
              const photo = photoList[photoIndex + slot];
              const img = new Image(); 
              img.src = photo.dataUrl;
              await new Promise(resolve => { 
                img.onload = resolve; 
                img.onerror = resolve; 
              });

              const ratio = img.width / img.height;
              let imgW = (pageW - 2 * margin) * 0.8;
              let imgH = imgW / ratio;
              const maxW2 = (pageW - 2 * margin);
              const maxH2 = contentH / 2 - 40;
              
              if (imgH > maxH2) { 
                imgH = maxH2; 
                imgW = imgH * ratio; 
              }

              const imgX = margin + (maxW2 - imgW) / 2;
              const imgY = yCursor;

              pdf.setDrawColor(200); 
              pdf.setLineWidth(0.5);
              pdf.rect(imgX - 2, imgY - 2, imgW + 4, imgH + 4);
              
              if (photo.rotation && photo.rotation !== 0) {
                pdf.saveGraphicsState();
                const centerX = imgX + imgW / 2;
                const centerY = imgY + imgH / 2;
                pdf.setGState(new pdf.GState({
                  CTM: [
                    Math.cos(photo.rotation * Math.PI / 180), 
                    Math.sin(photo.rotation * Math.PI / 180),
                    -Math.sin(photo.rotation * Math.PI / 180), 
                    Math.cos(photo.rotation * Math.PI / 180),
                    centerX, centerY
                  ]
                }));
                pdf.addImage(img, 'JPEG', -imgW / 2, -imgH / 2, imgW, imgH, '', 'FAST');
                pdf.restoreGraphicsState();
              } else {
                pdf.addImage(img, 'JPEG', imgX, imgY, imgW, imgH, '', 'FAST');
              }

              if (document.getElementById('showPhotoDetails').checked) {
                const detailsY = imgY + imgH + 8;
                pdf.setTextColor(0); 
                pdf.setFont('helvetica', 'bold'); 
                pdf.setFontSize(12);
                pdf.text(photo.designation || `Photo ${photo.id}`, pageW / 2, detailsY, {align: 'center'});
                pdf.setFont('helvetica', 'normal'); 
                pdf.setFontSize(10); 
                pdf.setTextColor(100);
                
                const stepText = `Étape: ${photo.stepNumber || 'N/A'}`;
                const dateText = `Date: ${formatDate(photo.date) || 'N/A'}`;
                const timeText = `Heure: ${formatTime(photo.time) || 'N/A'}`;
                const categoryText = `Catégorie: ${getCategoryName(photo.category)}`;
                const line1 = `${stepText} • ${dateText} • ${timeText}`;
                const line2 = categoryText;
                
                pdf.text(line1, pageW / 2, detailsY + 12, {align: 'center'});
                pdf.text(line2, pageW / 2, detailsY + 22, {align: 'center'});
              }

              if (slot === 0) { 
                yCursor = headerH + margin + (contentH / 2) + 15; 
              }
              
              totalProgress += progressPerPhoto; 
              bar.style.width = Math.min(95, totalProgress) + '%';
            }
            
            photoIndex += photosOnThisPage;
            addFooter();
          }
        }

        // Numérotation de pages
        const totalPages = pdf.internal.getNumberOfPages();
        for (let i = 1; i <= totalPages; i++) { 
          pdf.setPage(i); 
          addFooter(); 
        }
        bar.style.width = '100%';

        const fileName = `rapport-photos-${(info.affaire || 'projet').replace(/[^a-z0-9\-_]+/gi, '_').toLowerCase()}-${new Date().toISOString().slice(0, 10)}.pdf`;

        const pdfBlob = pdf.output('blob');
        
        if (document.getElementById('zipPackage')?.checked) {
          await exportZipWithPhotos(pdfBlob, fileName);
          showToast('ZIP (PDF + photos classées) généré avec succès !', 'success');
        } else {
          if (typeof saveAs !== 'undefined') {
            saveAs(pdfBlob, fileName);
          } else {
            // Fallback sans FileSaver.js
            const url = URL.createObjectURL(pdfBlob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            a.click();
            URL.revokeObjectURL(url);
          }
          showToast('Rapport PDF généré avec succès !', 'success');
        }
        
      } catch(e) {
        console.error('Erreur export PDF:', e); 
        showToast('Erreur lors de la génération du PDF/ZIP', 'error');
      } finally {
        const loading = document.getElementById('loadingSection');
        const btn = document.getElementById('exportButton');
        const bar = document.getElementById('progressBar');
        
        if (loading) loading.style.display = 'none'; 
        if (btn) btn.disabled = false; 
        if (bar) bar.style.width = '0';
      }
    }

    function validatePhotoFields() {
      for (const p of photos) { 
        if (!p.designation || !p.category || isNaN(p.stepNumber) || !p.date || !p.time) return false; 
      }
      return true;
    }
    
    function highlightMissingFields() {
      document.querySelectorAll('.photo-item').forEach(item => {
        const inputs = item.querySelectorAll('input'); 
        let hasMissing = false;
        
        inputs.forEach(input => { 
          if (!input.value) { 
            input.style.borderColor = '#e74c3c'; 
            hasMissing = true; 
          } else { 
            input.style.borderColor = ''; 
          }
        });
        
        const select = item.querySelector('select'); 
        if (!select.value) { 
          select.style.borderColor = '#e74c3c'; 
          hasMissing = true; 
        } else { 
          select.style.borderColor = ''; 
        }
        
        item.style.boxShadow = hasMissing ? '0 0 0 2px rgba(231,76,60,.25)' : '';
      });
    }

    function ts() { 
      return new Date().toISOString().replace(/:/g, '-').replace(/\./g, '-'); 
    }
  </script>
</body>
</html>
